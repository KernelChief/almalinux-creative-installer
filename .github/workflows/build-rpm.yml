name: Build RPMs

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g., 1.0.4 or v1.0.4). Leave empty to use main's latest tag."
        required: false
        default: ""
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build (EL${{ matrix.el }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        el: [9, 10]

    container:
      image: almalinux:${{ matrix.el }}

    steps:
      - name: Install build dependencies
        run: |
          dnf -y install \
            rpm-build rpmdevtools git bash \
            python3 python3-gobject gtk3 \
            polkit xdg-utils \
            rsync tar findutils
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build RPM
        env:
          TOPDIR: ${{ github.workspace }}/rpmbuild
          DISTDIR: ${{ github.workspace }}/dist
          VERSION: ${{ inputs.version != '' && inputs.version || (github.ref_type == 'tag' && github.ref_name) || '' }}
          GIT_DISCOVERY_ACROSS_FILESYSTEM: 1
        run: |
          mkdir -p "$TOPDIR" "$DISTDIR"
          # Ensure rpmbuild writes inside the shared workspace (not ~)
          export HOME="${{ github.workspace }}"
          mkdir -p "$HOME"/rpmbuild

          chmod +x src/packaging/build-rpm.sh
          ./src/packaging/build-rpm.sh

          # Collect RPMs into dist/
          find "$HOME/rpmbuild/RPMS" -type f -name "*.rpm" -exec cp -v {} "$DISTDIR/" \;

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-el${{ matrix.el }}
          path: dist/*.rpm

  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download EL9 artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpm-el9
          path: dist

      - name: Download EL10 artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpm-el10
          path: dist

      - name: List files (debug)
        run: |
          ls -lah dist
          echo "Found RPMs:"
          ls -lah dist/*.rpm || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.rpm
          generate_release_notes: false
          body: |
            ## :tada: AlmaLinux Creative Installer ${{ github.ref_name }}
            
            :white_check_mark: Highlights
            - (fill me in)
            
            :package: Assets
            - EL9 RPM
            - EL10 RPM (experimental)

