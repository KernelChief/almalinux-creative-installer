name: Build RPMs

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

# Least privilege by default (applies to all jobs unless overridden)
permissions:
  contents: read

jobs:
  build:
    name: Build (EL${{ matrix.el }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        el: [9, 10]

    container:
      image: almalinux:${{ matrix.el }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf -y install \
            rpm-build \
            rpmdevtools \
            python3 \
            python3-gobject \
            gtk3 \
            polkit \
            xdg-utils \
            rsync \
            tar

      - name: Build RPM
        run: |
          chmod +x src/packaging/build-rpm.sh
          # Build script reads Name/Version from spec, so no VERSION needed
          ./src/packaging/build-rpm.sh

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: RPM-EL${{ matrix.el }}
          path: /root/rpmbuild/RPMS/**/*.rpm

  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest

    # Only run release job for tag pushes (not manual workflow_dispatch)
    if: startsWith(github.ref, 'refs/tags/v')

    # This job needs to create/update a Release and upload assets
    permissions:
      contents: write

    steps:
      - name: Download EL9 artifacts
        uses: actions/download-artifact@v4
        with:
          name: RPM-EL9
          path: dist

      - name: Download EL10 artifacts
        uses: actions/download-artifact@v4
        with:
          name: RPM-EL10
          path: dist

      - name: Create GitHub Release (attach RPMs)
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*.rpm