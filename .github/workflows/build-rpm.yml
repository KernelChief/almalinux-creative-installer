name: Build RPMs

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g., 1.0.4 or v1.0.4). Leave empty to use main's latest tag."
        required: false
        default: ""
  push:
    tags:
      - "v*"
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    name: Build (EL${{ matrix.el }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        el: [9, 10]

    container:
      image: almalinux:${{ matrix.el }}

    steps:
      - name: Install build dependencies
        run: |
          dnf -y install \
            rpm-build rpmdevtools git bash \
            python3 python3-gobject gtk3 \
            polkit xdg-utils \
            rsync tar findutils
      - name: Checkout source
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Resolve build version
        id: resolve_version
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail

          # 1) workflow_dispatch explicit input wins
          if [ -n "${INPUT_VERSION}" ]; then
            VERSION="${INPUT_VERSION#v}"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "Resolved version from workflow input: ${VERSION}"
            exit 0
          fi

          # 2) Tag pushes use tag name
          if [ "${GITHUB_REF#refs/tags/}" != "${GITHUB_REF}" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#v}"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "Resolved version from tag: ${VERSION}"
            exit 0
          fi

          # 3) PR builds create beta pre-release from latest stable tag
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            BASE_TAG="$(git tag --list 'v*' --sort=-v:refname | head -n 1 || true)"
            BASE_VERSION="${BASE_TAG#v}"
            if [ -z "${BASE_VERSION}" ]; then
              BASE_VERSION="0.0.0"
            fi

            SHORT_SHA="$(printf '%s' "$GITHUB_SHA" | cut -c1-8)"
            VERSION="${BASE_VERSION}-beta.pr${{ github.event.pull_request.number }}.${SHORT_SHA}"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "Resolved version for PR beta build: ${VERSION}"
            exit 0
          fi

          # 4) Fallback for branch manual runs without input
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          VERSION="$(git tag --list 'v*' --sort=-v:refname | head -n 1 || true)"
          VERSION="${VERSION#v}"
          if [ -z "${VERSION}" ]; then
            echo "Could not resolve a version (no tags found)."
            exit 1
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Resolved version from latest tag fallback: ${VERSION}"

      - name: Build RPM
        env:
          TOPDIR: ${{ github.workspace }}/rpmbuild
          DISTDIR: ${{ github.workspace }}/dist
          VERSION: ${{ steps.resolve_version.outputs.version }}
          GIT_DISCOVERY_ACROSS_FILESYSTEM: 1
        run: |
          mkdir -p "$TOPDIR" "$DISTDIR"
          # Ensure rpmbuild writes inside the shared workspace (not ~)
          export HOME="${{ github.workspace }}"
          mkdir -p "$HOME"/rpmbuild
          echo "GITHUB_REF=$GITHUB_REF"
          echo "GITHUB_REF_NAME=$GITHUB_REF_NAME"
          echo "GITHUB_REF_TYPE=$GITHUB_REF_TYPE"
          echo "VERSION (env)=$VERSION"

          # Needed in containerized GitHub Actions runs to allow git commands.
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          # workflow_dispatch on branches may have empty VERSION.
          # Fallback to latest v* tag so manual runs still work without input.
          if [ -z "$VERSION" ]; then
            VERSION="$(git tag --list 'v*' --sort=-v:refname | head -n 1 || true)"
            VERSION="${VERSION#v}"
            export VERSION
            echo "VERSION (latest-tag fallback)=$VERSION"
          fi

          if [ -z "$VERSION" ] && [ "${GITHUB_REF#refs/tags/}" != "${GITHUB_REF}" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#v}"
            export VERSION
            echo "VERSION (fallback)=$VERSION"
          fi

          chmod +x src/packaging/build-rpm.sh
          ./src/packaging/build-rpm.sh

          # Collect RPMs into dist/
          find "$HOME/rpmbuild/RPMS" -type f -name "*.rpm" -exec cp -v {} "$DISTDIR/" \;

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v6
        with:
          name: rpm-el${{ matrix.el }}-${{ github.event_name == 'pull_request' && format('pr{0}', github.event.pull_request.number) || 'release' }}
          path: dist/*.rpm

  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout source (for tag fallback)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: resolve_tag
        run: |
          TAG=""
          if [ "${GITHUB_REF#refs/tags/}" != "${GITHUB_REF}" ]; then
            TAG="${GITHUB_REF#refs/tags/}"
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            TAG="${{ github.event.inputs.version }}"
          else
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            TAG="$(git tag --list 'v*' --sort=-v:refname | head -n 1 || true)"
          fi

          echo "tag_name=${TAG}" >> "$GITHUB_OUTPUT"
          if [ -n "${TAG}" ]; then
            echo "do_release=true" >> "$GITHUB_OUTPUT"
          else
            echo "do_release=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download EL9 artifacts
        if: steps.resolve_tag.outputs.do_release == 'true'
        uses: actions/download-artifact@v7
        with:
          name: rpm-el9-release
          path: dist

      - name: Download EL10 artifacts
        if: steps.resolve_tag.outputs.do_release == 'true'
        uses: actions/download-artifact@v7
        with:
          name: rpm-el10-release
          path: dist

      - name: List files (debug)
        if: steps.resolve_tag.outputs.do_release == 'true'
        run: |
          ls -lah dist
          echo "Found RPMs:"
          ls -lah dist/*.rpm || true

      - name: Create GitHub Release
        if: steps.resolve_tag.outputs.do_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve_tag.outputs.tag_name }}
          target_commitish: ${{ github.sha }}
          files: dist/*.rpm
          draft: true
          prerelease: ${{ contains(steps.resolve_tag.outputs.tag_name, '-rc') || contains(steps.resolve_tag.outputs.tag_name, '-beta') || contains(steps.resolve_tag.outputs.tag_name, '-alpha') }}
          generate_release_notes: false
          body: |
            ## :tada: AlmaLinux Creative Installer ${{ steps.resolve_tag.outputs.tag_name }}
            
            :white_check_mark: Highlights
            - (fill me in)
            
            ❤️ Special Thanks
            - Major thanks for the icon design to **Cristian Slavik** from **NOX Visual Effects**
              - GitHub: https://github.com/crisslavik
              - LinkedIn: https://www.linkedin.com/in/crisslavik/

            :package: Assets
            - EL9 RPM
            - EL10 RPM (experimental)

  pr-beta-comment:
    name: Comment beta RPM location on PR
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Add/update PR comment with beta RPM download link
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: beta-rpm
          message: |
            ✅ Beta RPMs are ready for this PR.

            Download them from this run's artifacts:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts

            Expected artifact names:
            - `rpm-el9-pr${{ github.event.pull_request.number }}`
            - `rpm-el10-pr${{ github.event.pull_request.number }}`

